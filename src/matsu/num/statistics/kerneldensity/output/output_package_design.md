# output パッケージの設計

`matsu.num.statistics.kerneldensity.output` パッケージのコンポーネントの設計を考えるためのドキュメントである.


## パッケージ開発の背景
`matsu.num.statistics.kerneldensity` で提供されている計算はDTOオブジェクトで返すのみであるので,
ユーザーが結果を利用するのにはDTOオブジェクトを加工しなければならない.
このパッケージは, ユーザーが広く利用できる, 汎用的な加工方法を提供する.


## 結果出力機能に関するAPI設計
### DTOオブジェクトのミュータビリティによる結果出力との整合性の問題
現状のDTOオブジェクトはミュータブルでフィールドが公開されたクラスである.
`double[][]` のようにモジュール外から構造そのものを変更できるフィールドも存在する.
したがって, 一度外部に渡されたインスタンスを再度受け取るようなAPI設計は危険である.
これにより結果出力機能は,
DTOオブジェクトを受け取るのではなく,
`matsu.num.statistics.kerneldensity` が持つ計算機能そのものをラップし,
自身の中で計算を実行するように設計する.

例えば, `KernelDensity1D` を基にした結果出力を考える.
ラップされる計算機能は `Range` を与えて `KdeGrid1dDto` を返すというものである.
これを `Function<Range,KdeGrid1dDto>` で表現するという選択肢もあるが,
`KernelDensity1D` と `Range` を直接受け取る構造にした方が安全性は高い
(インジェクション方法を外部に公開する場合は特に).

### 結果出力の型
結果出力は, 多くの場合, 適切にフォーマットされた文字列による出力が良い
(数値が欲しいというユースケースは, DTOオブジェクトをそのまま利用すればよい).
そこで, 文字列を1行ずつ返すことができる, `Iterable<String>` 型の戻り値が適切であると思われる.

### ラップされたDTOオブジェクトの取り扱い
DTOオブジェクトはそのミュータビリティが問題となるので,
結果出力機能がDTOオブジェクトへの参照を外部に露出しないならば,
結果出力のたびにコピーする必要は無い.
これを取り扱うには, DTOオブジェクトをラップしたクラスで表現し,
フォーマッターを与えて `Iterable<String>` を返すようなメソッドを用意すればよい.

## API全体の結果出力機能に関するAPI設計
全体の構造は次のようになる.

- DTOオブジェクトをラップした, 計算結果を表現するオブジェクト
    - 生成時に計算器と計算範囲を与える.
    - インスタンスメソッドは, `Iterable<String>` を返す. 引数でフォーマッターを渡す.
- 出力のフォーマッターを表現するオブジェクト
    - 抽象化してポリモーフィズムで扱えるようにする.
    - 悪意のあるフォーマッターが扱えないように, モジュール外で実装することが不可能な構造にする.
